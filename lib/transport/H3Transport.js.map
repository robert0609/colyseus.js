{"version":3,"file":"H3Transport.js","sourceRoot":"","sources":["../../src/transport/H3Transport.ts"],"names":[],"mappings":"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","sourcesContent":["import { ITransport, ITransportEventMap } from \"./ITransport\";\r\nimport { encode, decode, Iterator } from '@colyseus/schema';\r\n\r\nexport class H3TransportTransport implements ITransport {\r\n    wt: WebTransport;\r\n    isOpen: boolean = false;\r\n\r\n    reader: ReadableStreamDefaultReader;\r\n    writer: WritableStreamDefaultWriter;\r\n\r\n    unreliableReader: ReadableStreamDefaultReader<Uint8Array>;\r\n    unreliableWriter: WritableStreamDefaultWriter<Uint8Array>;\r\n\r\n    private lengthPrefixBuffer = new Uint8Array(9); // 9 bytes is the maximum length of a length prefix\r\n\r\n    constructor(public events: ITransportEventMap) { }\r\n\r\n    public connect(url: string, options: any = {}) {\r\n        const wtOpts: WebTransportOptions = options.fingerprint && ({\r\n            // requireUnreliable: true,\r\n            // congestionControl: \"default\", // \"low-latency\" || \"throughput\"\r\n\r\n            serverCertificateHashes: [{\r\n                algorithm: 'sha-256',\r\n                value: new Uint8Array(options.fingerprint).buffer\r\n            }]\r\n        }) || undefined;\r\n\r\n        this.wt = new WebTransport(url, wtOpts);\r\n\r\n        this.wt.ready.then((e) => {\r\n            console.log(\"WebTransport ready!\", e)\r\n            this.isOpen = true;\r\n\r\n            this.unreliableReader = this.wt.datagrams.readable.getReader();\r\n            this.unreliableWriter = this.wt.datagrams.writable.getWriter();\r\n\r\n            const incomingBidi = this.wt.incomingBidirectionalStreams.getReader();\r\n            incomingBidi.read().then((stream) => {\r\n                this.reader = stream.value.readable.getReader();\r\n                this.writer = stream.value.writable.getWriter();\r\n\r\n                // immediately write room/sessionId for establishing the room connection\r\n                this.sendSeatReservation(options.room.roomId, options.sessionId, options.reconnectionToken);\r\n\r\n                // start reading incoming data\r\n                this.readIncomingData();\r\n                this.readIncomingUnreliableData();\r\n\r\n            }).catch((e) => {\r\n                console.error(\"failed to read incoming stream\", e);\r\n                console.error(\"TODO: close the connection\");\r\n            });\r\n\r\n            // this.events.onopen(e);\r\n        }).catch((e: WebTransportCloseInfo) => {\r\n            // this.events.onerror(e);\r\n            // this.events.onclose({ code: e.closeCode, reason: e.reason });\r\n            console.log(\"WebTransport not ready!\", e)\r\n            this._close();\r\n        });\r\n\r\n        this.wt.closed.then((e: WebTransportCloseInfo) => {\r\n            console.log(\"WebTransport closed w/ success\", e)\r\n            this.events.onclose({ code: e.closeCode, reason: e.reason });\r\n\r\n        }).catch((e: WebTransportCloseInfo) => {\r\n            console.log(\"WebTransport closed w/ error\", e)\r\n            this.events.onerror(e);\r\n            this.events.onclose({ code: e.closeCode, reason: e.reason });\r\n        }).finally(() => {\r\n            this._close();\r\n        });\r\n    }\r\n\r\n    public send(data: Buffer | Uint8Array): void {\r\n        const prefixLength = encode.number(this.lengthPrefixBuffer, data.length, { offset: 0 });\r\n        const dataWithPrefixedLength = new Uint8Array(prefixLength + data.length);\r\n        dataWithPrefixedLength.set(this.lengthPrefixBuffer.subarray(0, prefixLength), 0);\r\n        dataWithPrefixedLength.set(data, prefixLength);\r\n        this.writer.write(dataWithPrefixedLength);\r\n    }\r\n\r\n    public sendUnreliable(data: Buffer | Uint8Array): void {\r\n        const prefixLength = encode.number(this.lengthPrefixBuffer, data.length, { offset: 0 });\r\n        const dataWithPrefixedLength = new Uint8Array(prefixLength + data.length);\r\n        dataWithPrefixedLength.set(this.lengthPrefixBuffer.subarray(0, prefixLength), 0);\r\n        dataWithPrefixedLength.set(data, prefixLength);\r\n        this.unreliableWriter.write(dataWithPrefixedLength);\r\n    }\r\n\r\n    public close(code?: number, reason?: string) {\r\n        try {\r\n            this.wt.close({ closeCode: code, reason: reason });\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    }\r\n\r\n    protected async readIncomingData() {\r\n        let result: ReadableStreamReadResult<Uint8Array>;\r\n\r\n        while (this.isOpen) {\r\n            try {\r\n                result = await this.reader.read();\r\n\r\n                //\r\n                // a single read may contain multiple messages\r\n                // each message is prefixed with its length\r\n                //\r\n\r\n                const messages = result.value;\r\n                const it: Iterator = { offset: 0 };\r\n                do {\r\n                    //\r\n                    // QUESTION: should we buffer the message in case it's not fully read?\r\n                    //\r\n\r\n                    const length = decode.number(messages, it);\r\n                    this.events.onmessage({ data: messages.subarray(it.offset, it.offset + length) });\r\n                    it.offset += length;\r\n                } while (it.offset < messages.length);\r\n\r\n            } catch (e) {\r\n                if (e.message.indexOf(\"session is closed\") === -1) {\r\n                    console.error(\"H3Transport: failed to read incoming data\", e);\r\n                }\r\n                break;\r\n            }\r\n\r\n            if (result.done) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    protected async readIncomingUnreliableData() {\r\n        let result: ReadableStreamReadResult<Uint8Array>;\r\n\r\n        while (this.isOpen) {\r\n            try {\r\n                result = await this.unreliableReader.read();\r\n\r\n                //\r\n                // a single read may contain multiple messages\r\n                // each message is prefixed with its length\r\n                //\r\n\r\n                const messages = result.value;\r\n                const it: Iterator = { offset: 0 };\r\n                do {\r\n                    //\r\n                    // QUESTION: should we buffer the message in case it's not fully read?\r\n                    //\r\n\r\n                    const length = decode.number(messages, it);\r\n                    this.events.onmessage({ data: messages.subarray(it.offset, it.offset + length) });\r\n                    it.offset += length;\r\n                } while (it.offset < messages.length);\r\n\r\n            } catch (e) {\r\n                if (e.message.indexOf(\"session is closed\") === -1) {\r\n                    console.error(\"H3Transport: failed to read incoming data\", e);\r\n                }\r\n                break;\r\n            }\r\n\r\n            if (result.done) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    protected sendSeatReservation (roomId: string, sessionId: string, reconnectionToken?: string) {\r\n        const it: Iterator = { offset: 0 };\r\n        const bytes: number[] = [];\r\n\r\n        encode.string(bytes, roomId, it);\r\n        encode.string(bytes, sessionId, it);\r\n\r\n        if (reconnectionToken) {\r\n            encode.string(bytes, reconnectionToken, it);\r\n        }\r\n\r\n        this.writer.write(new Uint8Array(bytes).buffer);\r\n    }\r\n\r\n    protected _close() {\r\n        this.isOpen = false;\r\n    }\r\n\r\n}\r\n"]}