{"version":3,"file":"Storage.js","sourceRoot":"","sources":["../src/Storage.ts"],"names":[],"mappings":"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","sourcesContent":["/// <reference path=\"../typings/cocos-creator.d.ts\" />\r\n\r\n/**\r\n * We do not assign 'storage' to window.localStorage immediatelly for React\r\n * Native compatibility. window.localStorage is not present when this module is\r\n * loaded.\r\n */\r\n\r\nlet storage: any;\r\n\r\nfunction getStorage(): Storage {\r\n    if (!storage)  {\r\n        try {\r\n            storage = (typeof (cc) !== 'undefined' && cc.sys && cc.sys.localStorage)\r\n                ? cc.sys.localStorage  // compatibility with cocos creator\r\n                : window.localStorage; // RN does have window object at this point, but localStorage is not defined\r\n\r\n        } catch (e) {\r\n            // ignore error\r\n        }\r\n    }\r\n\r\n    if (!storage && typeof (globalThis.indexedDB) !== 'undefined') {\r\n        storage = new IndexedDBStorage();\r\n    }\r\n\r\n    if (!storage) {\r\n        // mock localStorage if not available (Node.js or RN environment)\r\n        storage = {\r\n            cache: {},\r\n            setItem: function (key, value) { this.cache[key] = value; },\r\n            getItem: function (key) { this.cache[key]; },\r\n            removeItem: function (key) { delete this.cache[key]; },\r\n        };\r\n    }\r\n\r\n    return storage;\r\n}\r\n\r\nexport function setItem(key: string, value: string) {\r\n    getStorage().setItem(key, value);\r\n}\r\n\r\nexport function removeItem(key: string) {\r\n    getStorage().removeItem(key);\r\n}\r\n\r\nexport function getItem(key: string, callback: Function) {\r\n    const value: any = getStorage().getItem(key);\r\n\r\n    if (\r\n        typeof (Promise) === 'undefined' || // old browsers\r\n        !(value instanceof Promise)\r\n    ) {\r\n        // browser has synchronous return\r\n        callback(value);\r\n\r\n    } else {\r\n        // react-native is asynchronous\r\n        value.then((id) => callback(id));\r\n    }\r\n}\r\n\r\n/**\r\n * When running in a Web Worker, we need to use IndexedDB to store data.\r\n */\r\nclass IndexedDBStorage {\r\n    private dbPromise: Promise<IDBDatabase> = new Promise((resolve) => {\r\n        const request = indexedDB.open('_colyseus_storage', 1);\r\n        request.onupgradeneeded = () => request.result.createObjectStore('store');\r\n        request.onsuccess = () => resolve(request.result);\r\n    });\r\n\r\n    private async tx(mode: IDBTransactionMode, fn: (store: IDBObjectStore) => IDBRequest) {\r\n        const db = await this.dbPromise;\r\n        const store = db.transaction('store', mode).objectStore('store');\r\n        return fn(store);\r\n    }\r\n\r\n    setItem(key: string, value: string) {\r\n        return this.tx('readwrite', store => store.put(value, key)).then();\r\n    }\r\n\r\n    async getItem(key: string) {\r\n        const request = await this.tx('readonly', store => store.get(key));\r\n        return new Promise<string | undefined>((resolve) => {\r\n            request.onsuccess = () => resolve(request.result);\r\n        });\r\n    }\r\n\r\n    removeItem(key: string) {\r\n        return this.tx('readwrite', store => store.delete(key)).then();\r\n    }\r\n}"]}